FROM postgres:11.3-alpine

WORKDIR /
COPY migrations migrations/

# Strip the "goose down" bits from migrations so they can run automatically
# Then, move them into docker-entrypoint-initdb.d which automatically runs any
# .sql or .sh files inside it
RUN apk add --no-cache sed
RUN for file in $(ls /migrations); do \
			sed '/+goose Down/,$d' "/migrations/$file" > "/docker-entrypoint-initdb.d/$file"; \
		done

# Database will start from postgres image because we didn't override ENTRYPOINT
